<html>
<link rel="stylesheet" type="text/css" href="../../static/main.css">
<form id="data">
<input type="hidden" value="{{id}}" name="sessionId">
<input type="hidden" value="{{function_name}}" name="function_name">
<input type="hidden" value="{{goal}}" name="goal">
<input type="hidden" value="{{function}}" name="function">
<input type="hidden" value="{{max_score}}" name="max_score">
<input type="hidden" value="{{test_response}}" name="test_response">
<input type="hidden" value="{{test_start_time}}" name="test_start_time">
<input type="hidden" value="{{test_response_time}}" name="test_response_time">
<input type="hidden" value="{{predict_prompt}}" name="predict_prompt">
<input type="hidden" value="{{predict_response}}" name="predict_response">
<input type="hidden" value="{{predict_start_time}}" name="predict_start_time">
<input type="hidden" value="{{predict_response_time}}" name="predict_response_time">
<input type="hidden" value="{{final_score}}" name="final_score">
<input type="hidden" value="{{max_total_score}}" name="max_total_score">


<input type="hidden" value="{{max_height}}" name="max_height">
<input type="hidden" value="{{bar_width}}" name="bar_width">
<input type="hidden" value="{{number_of_bars}}" name="number_of_bars">
<input type="hidden" value="{{plot_width}}" name="plot_width">
<input type="hidden" value="{{experiment}}" name="experiment">
<input type="hidden" value="{{version}}" name="experimentVersion">
<input type="hidden" value="{{se_function_lengthscale}}" name="se_function_lengthscale">
<div>
What is your age? Choose "NA" if you prefer not to say.
<br>
<select name="age" class="age"></select>
</div>
<div>
What was the goal of the game?
<br>
<textarea name="describe_goal"></textarea>
</div>
<div id="describe_strategy">
</div>
<div id="describe_strategy_phase2">
What was your strategy in playing the second part of the game?
<br>
<textarea name="describe_strategy_phase2"></textarea>
</div>
<div>
Was anything unclear or confusing about the game?
<br>
<textarea name="describe_unclear"></textarea>
</div>
</form>
<div id="buttondiv">
  <button onclick="return log()">Submit</button>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script type="text/javascript">
var describe = document.getElementById('describe_strategy')
if ('{{goal}}' == 'min_error'){
  describe.innerHTML = 'What was your strategy in playing the first part of the game?'
  var input = document.createElement("textarea");
}else{
  describe.innerHTML = 'What was your strategy in playing the game?'
  document.getElementById('describe_strategy_phase2').style.display="none"
}
var linebreak = document.createElement("br")
var input = document.createElement("textarea")
input.name = 'describe_strategy'
describe.appendChild(linebreak)
describe.appendChild(input)

// For testing, use localhost where possible
var wso = new WebSocket("ws://somata.inf.ed.ac.uk/chunks/ws");
var wsError = 0; // Keeps track of whether any websocket errors have occurred
var doneState = 0;
var wsMessageCode = "N00";
wso.onopen = function() {
  /* Send a small message to the console once the connection is established */
  console.log('chunk ws connection open.');
}

wso.onmessage = function(event) {
  message = JSON.parse(event.data);
  console.log('received websocket message: ' + message);
  wsMessageCode = "Y"+wsError+"-"+message.length;
  if(doneState == 1) {document.getElementById("buttondiv").innerHTML = "Thanks! You're all done. Please submit the code " + wsMessageCode;}
}

wso.onerror = function(error){
  console.log('websocket error detected: ' + JSON.stringify(error));
  wsError = 1;
}

function sendData(dataChunk) {
  dataChunk["experimentId"]="algoals";
  // Added these elements in order to see if some participants are using windows that are too small, causing wraparound of the bars.
  dataChunk["windowHeight"]=$(window).height();
  dataChunk["windowWidth"]=$(window).width();


  // isComplete allows the server to record completion, but is optional
  dataChunk["isComplete"] = true;
  var dataStr = JSON.stringify(dataChunk);
  wso.send(dataStr);
  doneState = 1;
  // The getElementById should be overwritten almost immediately by the websocket return message
  document.getElementById("buttondiv").innerHTML = "submitting (If submission doesn't complete in 10 seconds, please inform the requester)"
  // Could wait to see if storage is successful, or jump immediately to a completion page. Doing nothing yet.
  // window.location.href = "./code.html"
}
</script>

<script type="text/javascript">
$(function(){
    var $select = $(".age");
    $select.append('<option>NA</option>')
    for (i=18;i<=100;i++){
        $select.append($('<option></option>').val(i).html(i))
    }
});

function log(){
      var formArray=$("#data").serializeArray()
      var returnArray = {};
      for (var i = 0; i < formArray.length; i++){
        console.log(formArray[i]['name'])
      	if (formArray[i]['value'][0] == '['){
      		returnArray[formArray[i]['name']] = JSON.parse("[" + formArray[i]['value'] + "]")[0]
      	}else if (isNaN(formArray[i]['value']) || formArray[i]['name'].indexOf('describe') !== -1){
      		returnArray[formArray[i]['name']] = formArray[i]['value'];
      	}else{
      		returnArray[formArray[i]['name']] = parseFloat(formArray[i]['value'])
      	}
      }
      console.log('sending: ' + returnArray);
      console.log(returnArray)
      sendData(returnArray);
}


</script>
</html>